import React, { useState, useEffect, useRef } from 'react';
import VerificationForm from './VerificationForm';
import "./otp.css";
import SignUpMain from '../SignUpMain'; // ‚úÖ Import SignUpPage component
const SendOtpWithNumber = ({ forceOpen = false, onClose }) => {
  const [showPopup, setShowPopup] = useState(false);
  const [phoneNumber, setPhoneNumber] = useState('');
  const [showOtpForm, setShowOtpForm] = useState(false);
  const [serverOtp, setServerOtp] = useState(null);
  const [showSignupPage, setShowSignupPage] = useState(false); // üî∏ store OTP if needed for testing
  const timerRef = useRef(null);

  useEffect(() => {
     if (forceOpen) {
    setShowPopup(true); // ‚úÖ force open the modal immediately
    return;
  } // skip timer if opened manually

    const userCookie = document.cookie
      .split('; ')
      .find(row => row.startsWith('user='));

    if (userCookie) return;

    timerRef.current = setTimeout(() => {
      setShowPopup(true);
    }, 10000);

    return () => clearTimeout(timerRef.current);
  }, [forceOpen]);


 const handleClose = () => {
    setShowPopup(false);
    if (onClose) onClose();
    clearTimeout(timerRef.current);
  };
  const handleSubmitNumber = async (e) => {
    e.preventDefault();

    try {
      const res = await fetch(`${import.meta.env.VITE_API_URL}/api/send-otp`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone: phoneNumber }),
      });

      const data = await res.json();

      if (data.success) {
        setShowOtpForm(true);
        setServerOtp(data.otp); // üëà optional: for dev/testing only
      } else {
        alert("‚ùå Failed to send OTP");
      }
    } catch (err) {
      alert("‚ùå Error: " + err.message);
    }
  };

  if (!showPopup) return null;

  return (
   
<>
         {showSignupPage ? (
          <SignUpMain phoneNumber={phoneNumber} /> // ‚úÖ Directly render SignUpPage
        ) :(
        !showOtpForm ? (
           <div className="popup-overlay">
      <div className="popup-content">
        <button className="close-button" onClick={handleClose}>‚úï</button>
          <form className="number-form" onSubmit={handleSubmitNumber}>
            <h3 className="popup-title">Verify Your Account</h3>
            <p className="popup-subtitle">Please enter your phone number to receive OTP</p>

            <div className="input-group">
              <input
                type="tel"
                value={phoneNumber}
                onChange={(e) => setPhoneNumber(e.target.value)}
                placeholder="Enter phone number"
                required
              />
            </div>

            <button type="submit" className="verify-button">
              Send OTP
            </button>
          </form>
           </div>
    </div>
        ) : (
           <div className="popup-overlay">
      <div className="popup-content">
        <button className="close-button" onClick={handleClose}>‚úï</button>
          <VerificationForm
            phoneNumber={phoneNumber}
            onClose={handleClose}
            serverOtp={serverOtp} // üëà pass OTP to VerificationForm (only during dev)
             onVerified={() => {
    setShowOtpForm(false);         // ‚úÖ Hide OTP form
    setShowSignupPage(true);       // ‚úÖ Show signup page
  }}
          />
          </div>
    </div>
        ))}
     </>
  );
};

export default SendOtpWithNumber;
